{% extends "base.html" %}

{% block title %}Dashboard - Sistema de Recomendaci√≥n de Libros{% endblock %}

{% block content %}
<div class="container">
	<div class="row g-3">
		<div class="col-12">
			<div class="card card-ghost p-3">
				<div class="d-flex align-items-center jus">
					<div class="me-3">
						<i class="bi bi-person-circle fs-1 text-primary"></i>
					</div>
					<div>
						<h4 class="mb-0">Hola, {{ user.name if user and user.name else user.alias if user else 'Usuario' }} üëã</h4>
						<p class="text-muted mb-0">Bienvenido a Libros ‚Äî tus recomendaciones personales te esperan.</p>
					</div>
					<div class="w-100 position-relative">
						<form id="buscarLibro" autocomplete="off">
							<div class="input-group mt-2">
								<input type="text" class="form-control" placeholder="Buscar libros..." id="libroText" aria-label="Buscar libros" />
								<button type="submit" class="btn btn-primary">
									<i class="bi bi-search"></i>
								</button>
							</div>
							<!-- Historial suggestions dropdown (absolute, custom styles) -->
							<div id="historialDropdown" class="historial-dropdown" aria-expanded="false">
								<div id="historialList" class="historial-list" role="list"></div>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>

		<div class="col-lg-8">
			<div class="row g-3">
				<div class="col-12">
					<div class="card p-3">
						<div class="d-flex justify-content-between align-items-center">
							<div>
								<div class="text-muted small">Libros totales</div>
								<!-- <div class="fs-4 fw-bold">{{ stats.total_libros if stats and stats.total_libros is not none else '‚Äî' }}</div> -->
								<div class="fs-4 fw-bold">{{ totalLibros if totalLibros is not none else '‚Äî' }}</div>
							</div>
							<i class="bi bi-book-half fs-2 text-secondary"></i>
						</div>
					</div>
				</div>
				<div class="col-12">
					<div id="libroLista" class="row g-3" aria-live="polite" aria-atomic="true"></div>
					<div id="noBooksMsg" class="alert alert-info mt-3 d-none" role="status">No se encontraron libros para los filtros aplicados.</div>
					<div class="d-flex justify-content-center mt-3">
						<button id="loadMoreBtn" class="btn btn-outline-primary">Cargar m√°s</button>
					</div>
				</div>
					
				
			</div>
		</div>

		<div class="col-lg-4">
			<div class="card p-3">
				<h6>Acciones r√°pidas</h6>
				<div class="d-grid gap-2">
					<a href="{{ url_for('libro.crear_libro_web') }}" class="btn btn-primary">Agregar nuevo libro</a>
					<a href="{{ url_for('libro.lista_libros_web') }}" class="btn btn-outline-primary">Ver todos los libros</a>
					<a href="{{ url_for('auth.logout') }}" class="btn btn-outline-secondary">Cerrar sesi√≥n</a>
				</div>
			</div>
			<div class="card p-3 mt-3">
				<h6>Tips</h6>
				<ul class="mb-0">
					<li class="small text-muted">Agrega libros con descripci√≥n completa para mejores recomendaciones.</li>
					<li class="small text-muted">Califica los libros para mejorar tu perfil.</li>
				</ul>
			</div>
		</div>
	</div>
</div>

{% endblock %}

{% block extra_js %}
<script>
$(function(){
	// Estado de paginaci√≥n cliente
	let offset = 0;
	const limit = 6;

	// Render suggestions into the dropdown
	function renderHistorial(items){
		const $list = $('#historialList');
		$list.empty();
		if(!items || items.length === 0) {
			$list.html('<div class="historial-empty">No hay b√∫squedas recientes</div>');
			$('#historialDropdown').show();
			return;
		}
		items.forEach(it => {
			const safeText = (it.textoBusqueda || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
			const $item = $(`<div class="historial-item" role="button" tabindex="0"><span class="text">${safeText}</span></div>`);
			$item.on('click keypress', function(e){
				if(e.type === 'click' || (e.type === 'keypress' && (e.key === 'Enter' || e.key === ' '))){
					$('#libroText').val(it.textoBusqueda);
					$('#historialDropdown').hide();
					$('#buscarLibro').submit();
				}
			});
			$list.append($item);
		});
		$('#historialDropdown').show();
	}

	// Close dropdown when clicking outside
	$(document).on('click', function(e){
		if(!$(e.target).closest('#buscarLibro').length){
			$('#historialDropdown').hide();
		}
	});

	// Fetch historial suggestions from server
	function fetchHistorial(query){
		$.ajax({
			url: "{{ url_for('historial.obtener_historial') }}",
			type: "GET",
			data: { textoBusqueda: query },
			success: function(response){
				const items = response.data && response.data.historiales ? response.data.historiales : [];
				renderHistorial(items);
			},
			error: function(){
				renderHistorial([]);
			}
		});
	}

	$('#libroText').on('input', function(){
		const q = $(this).val().trim();
		if(q.length >= 1) fetchHistorial(q);
		else fetchHistorial('');
	});

	$('#buscarLibro').on('submit', function(e){
		e.preventDefault();
		const buscar = $('#libroText').val()?.trim();
		offset = 0; // resetear paginaci√≥n al nueva b√∫squeda
		$('#libroLista').empty();
		obtenerLibros({ titulo: buscar }, offset, limit);
		if(!buscar) return;
		// Register historial entry (best-effort)
		$.post("{{ url_for('historial.crear_historial') }}", { textoBusqueda: buscar });
		$('#historialDropdown').hide();
	});

	$('#loadMoreBtn').on('click', function(){
		offset += limit;
		const buscar = $('#libroText').val()?.trim();
		obtenerLibros({ titulo: buscar }, offset, limit);
	});

	function obtenerLibros(filtros = {}, offsetParam = 0, limitParam = limit) {
		// $('#loadMoreBtn').prop('disabled', true).text('Cargando...');
		const apiUrl = '{{ url_for("libro.obtener_libros_web") }}';
		$.ajax({
			url: apiUrl,
			method: 'GET',
			data: { ...filtros, offset: offsetParam, limit: limitParam },
			success: function(response) {
				console.log('Libros obtenidos:', response);
				const libros = response.data && response.data.libros ? response.data.libros : [];
				if (libros.length > 0) {
					$('#noBooksMsg').addClass('d-none');
					libros.forEach(libro => appendLibro(libro));
				} else if (offsetParam === 0) {
					$('#noBooksMsg').removeClass('d-none');
				}
				// Re-enable load more if we received a full page
				if (libros.length >= limitParam) {
					$('#loadMoreBtn').prop('disabled', false).text('Cargar m√°s');
				} else {
					$('#loadMoreBtn').prop('disabled', true).text('No hay m√°s');
				}
			},
			error: function() {
				alert('Error al obtener los libros.');
				$('#loadMoreBtn').prop('disabled', false).text('Cargar m√°s');
			}
		});
	}

	function appendLibro(libro) {
		const id = libro._id || libro.id || libro.id_libro || '';
		const titulo = (libro.titulo || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
		const autor = (libro.autor || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
		const editorial = (libro.editorial || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
		const etiquetas = (libro.genero || []).map(g => `<span class="badge bg-secondary">${String(g).replace(/</g,'&lt;')}</span>`).join('');
		const anio = libro.a√±o_publicacion || libro.anio_publicacion || '';
		const descripcion = libro.descripcion ? String(libro.descripcion).substring(0,120).replace(/</g,'&lt;') : '';

		const libroHtml = `
			<div class="col-6 col-sm-4 col-md-3 mb-3" data-id="${id}">
				<div class="card h-100 book-card small-card shadow-sm">
					${libro.portada_url ? `<img src="${libro.portada_url}" loading="lazy" class="card-img-top book-card-img" alt="Portada de ${titulo}">` : `<div class="book-card-img d-flex align-items-center justify-content-center text-muted">No disponible</div>`}
					<div class="card-body d-flex flex-column py-2 px-2">
						<h6 class="card-title mb-1">${titulo}</h6>
						<p class="card-text mb-1 text-muted small">${autor} ‚Äî ${editorial}</p>
						<div class="card-badges mb-1">${etiquetas}<span class="badge bg-light text-dark">${libro.origen_pais || ''}</span><span class="badge bg-info text-white">${anio}</span></div>
						<p class="card-description text-muted xsmall mb-2">${descripcion}</p>
						<div class="mt-auto d-flex gap-1">
							<button class="btn btn-sm btn-primary w-100 view-book" title="Ver" data-id="${id}">Ver</button>
						</div>
					</div>
				</div>
			</div>`;

		$('#libroLista').append(libroHtml);
	}

	// Cargar primeras tarjetas al cargar la p√°gina
});
</script>
{% endblock %}
{% block extra_css %}
<style>
/* Custom historial dropdown styles (no Bootstrap list styles) */
.historial-dropdown {
	position: absolute;
	left: 0;
	right: 0;
	z-index: 1050;
	display: none;
	max-height: 300px;
	overflow: auto;
	background: linear-gradient(180deg, #ffffff, #fbfdff);
	border: 1px solid rgba(20,30,60,0.06);
	box-shadow: 0 8px 30px rgba(18,35,60,0.08);
	border-radius: 12px;
	padding: 8px;
}
.historial-item {
	padding: 10px 12px;
	border-radius: 8px;
	margin: 6px 4px;
	cursor: pointer;
	display: flex;
	align-items: center;
	gap: 10px;
	transition: background .12s ease, transform .06s ease;
}
.historial-item:hover { background: rgba(66,133,244,0.06); transform: translateY(-1px); }
.historial-item .hint { font-size: .85rem; color: #6b7280; }
.historial-item .text { font-size: .95rem; color: #0f172a; font-weight:600; }
.historial-empty { padding: 10px 12px; color:#94a3b8; font-size:.9rem; }
/* Compact card styles */
.small-card .book-card-img { height: 140px; object-fit: cover; }
.small-card .card-title { font-size: 0.95rem; }
.small-card .card-text { font-size: 0.75rem; }
.small-card .card-description.xsmall { font-size: 0.7rem; color: #6b7280; }
.small-card .card-body { padding: .5rem; }
.small-card .btn { padding: .35rem .5rem; font-size: .82rem; }
.small-card .card-badges .badge { font-size: .65rem; margin-right: 3px; }
</style>
{% endblock %}