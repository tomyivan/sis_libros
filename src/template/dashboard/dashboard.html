{% extends "base.html" %}

{% block title %}Dashboard - Sistema de RecomendaciÃ³n de Libros{% endblock %}

{% block content %}
<div class="container">
	<div class="row g-3">
		<div class="col-12">
			<div class="card card-ghost p-3">
				<div class="d-flex align-items-center jus">
					<div class="me-3">
						<i class="bi bi-person-circle fs-1 text-primary"></i>
					</div>
					<div>
						<h4 class="mb-0">Hola, {{ user.name if user and user.name else user.alias if user else 'Usuario' }} ðŸ‘‹</h4>
						<p class="text-muted mb-0">Bienvenido a Libros â€” tus recomendaciones personales te esperan.</p>
					</div>
					<div class="w-100 position-relative">
						<form id="buscarLibro" autocomplete="off">
							<div class="input-group mt-2">
								<input type="text" class="form-control" placeholder="Buscar libros..." id="libroText" aria-label="Buscar libros" />
								<button type="submit" class="btn btn-primary">
									<i class="bi bi-search"></i>
								</button>
							</div>
							<!-- Historial suggestions dropdown (absolute, custom styles) -->
							<div id="historialDropdown" class="historial-dropdown" aria-expanded="false">
								<div id="historialList" class="historial-list" role="list"></div>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>

		<div class="col-lg-8">
			<div class="row g-3">
				<div class="col-6">
					<div class="card p-3">
						<div class="d-flex justify-content-between align-items-center">
							<div>
								<div class="text-muted small">Libros totales</div>
								<div class="fs-4 fw-bold">{{ stats.total_libros if stats and stats.total_libros is not none else 'â€”' }}</div>
							</div>
							<i class="bi bi-book-half fs-2 text-secondary"></i>
						</div>
					</div>
				</div>

				<div class="col-6">
					<div class="card p-3">
						<div class="d-flex justify-content-between align-items-center">
							<div>
								<div class="text-muted small">Recomendaciones</div>
								<div class="fs-4 fw-bold">{{ stats.recomendaciones if stats and stats.recomendaciones is not none else 'â€”' }}</div>
							</div>
							<i class="bi bi-stars fs-2 text-warning"></i>
						</div>
					</div>
				</div>

				<div class="col-12">
					<div class="card p-3">
						<h5>Libros recientes</h5>
						{% if recent_libros and recent_libros|length > 0 %}
							<ul class="list-group list-group-flush">
								{% for libro in recent_libros %}
									<li class="list-group-item d-flex justify-content-between align-items-start">
										<div>
											<div class="fw-semibold">{{ libro.get('titulo') }}</div>
											<div class="text-muted small">{{ libro.get('autor') }} â€¢ {{ libro.get('genero') }}</div>
										</div>
										<div>
											<a class="btn btn-sm btn-outline-primary me-1" href="{{ url_for('libro.obtener_libro_web', libro_id=libro.get('_id') or libro.get('id')) }}">Ver</a>
											<a class="btn btn-sm btn-outline-secondary" href="{{ url_for('libro.crear_libro_web') }}?edit_id={{ libro.get('_id') or libro.get('id') }}">Editar</a>
										</div>
									</li>
								{% endfor %}
							</ul>
						{% else %}
							<p class="text-muted mb-0">AÃºn no hay libros recientes. Puedes <a href="{{ url_for('libro.crear_libro_web') }}">agregar uno</a>.</p>
						{% endif %}
					</div>
				</div>
			</div>
		</div>

		<div class="col-lg-4">
			<div class="card p-3">
				<h6>Acciones rÃ¡pidas</h6>
				<div class="d-grid gap-2">
					<a href="{{ url_for('libro.crear_libro_web') }}" class="btn btn-primary">Agregar nuevo libro</a>
					<a href="{{ url_for('libro.lista_libros_web') }}" class="btn btn-outline-primary">Ver todos los libros</a>
					<a href="{{ url_for('auth.logout') }}" class="btn btn-outline-secondary">Cerrar sesiÃ³n</a>
				</div>
			</div>
			<div class="card p-3 mt-3">
				<h6>Tips</h6>
				<ul class="mb-0">
					<li class="small text-muted">Agrega libros con descripciÃ³n completa para mejores recomendaciones.</li>
					<li class="small text-muted">Califica los libros para mejorar tu perfil.</li>
				</ul>
			</div>
		</div>
	</div>
</div>

{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function(){
	// Debounce helper
	function debounce(fn, wait){
		let t;
		return function(){
			const ctx = this, args = arguments;
			clearTimeout(t);
			t = setTimeout(()=> fn.apply(ctx, args), wait);
		}
	}

	// Render suggestions into the dropdown
	function renderHistorial(items){
		const $list = $('#historialList');
		$list.empty();
		if(!items || items.length === 0) {
			$list.html('<div class="historial-empty">No hay bÃºsquedas recientes</div>');
			$('#historialDropdown').show();
			return;
		}
		items.forEach(it => {
			const safeText = (it.textoBusqueda || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
			const $item = $(`<div class="historial-item" role="button" tabindex="0"><span class="text">${safeText}</span></div>`);
			$item.on('click keypress', function(e){
				if(e.type === 'click' || (e.type === 'keypress' && (e.key === 'Enter' || e.key === ' '))){
					$('#libroText').val(it.textoBusqueda);
					$('#historialDropdown').hide();
					// trigger a search submit
					$('#buscarLibro').submit();
				}
			});
			$list.append($item);
		});
		$('#historialDropdown').show();
	}

	// Close dropdown when clicking outside
	$(document).on('click', function(e){
		if(!$(e.target).closest('#buscarLibro').length){
			$('#historialDropdown').hide();
		}
	});

	// Fetch historial suggestions from server
	function fetchHistorial(query){
		$.ajax({
			url: "{{ url_for('historial.obtener_historial') }}",
			type: "GET",
			data: { textoBusqueda: query },
			success: function(response){
				const items = response.data && response.data.historiales ? response.data.historiales : [];
				renderHistorial(items);
			},
			error: function(){
				renderHistorial([]);
			}
		});
	}

	// Wire input events with debounce
	const debouncedFetch = debounce(function(){
		const q = $('#libroText').val().trim();
		if(q.length >= 1) { // show suggestions starting at 1 char for nicer UX
			fetchHistorial(q);
		} else {
			// show recent (empty query)
			fetchHistorial('');
		}
	}, 300);

	$('#libroText').on('input', debouncedFetch);

	$('#buscarLibro').on('submit', function(e){
		e.preventDefault();
		const buscar = $('#libroText').val()?.trim();
		if(!buscar) return;
		// Register historial entry (best-effort)
		$.ajax({
			url: "{{ url_for('historial.crear_historial') }}",
			type: "POST",
			data: { textoBusqueda: buscar },
			success: function(){
				// Optionally refresh suggestions
				fetchHistorial(buscar);
			},
			error: function(){ }
		});
		// TODO: run actual book search / navigate results
		console.log('Buscar libro (submit):', buscar);
		$('#historialDropdown').hide();
	});
});
</script>
{% endblock %}
{% block extra_css %}
<style>
/* Custom historial dropdown styles (no Bootstrap list styles) */
.historial-dropdown {
	position: absolute;
	left: 0;
	right: 0;
	z-index: 1050;
	display: none;
	max-height: 300px;
	overflow: auto;
	background: linear-gradient(180deg, #ffffff, #fbfdff);
	border: 1px solid rgba(20,30,60,0.06);
	box-shadow: 0 8px 30px rgba(18,35,60,0.08);
	border-radius: 12px;
	padding: 8px;
}
.historial-item {
	padding: 10px 12px;
	border-radius: 8px;
	margin: 6px 4px;
	cursor: pointer;
	display: flex;
	align-items: center;
	gap: 10px;
	transition: background .12s ease, transform .06s ease;
}
.historial-item:hover { background: rgba(66,133,244,0.06); transform: translateY(-1px); }
.historial-item .hint { font-size: .85rem; color: #6b7280; }
.historial-item .text { font-size: .95rem; color: #0f172a; font-weight:600; }
.historial-empty { padding: 10px 12px; color:#94a3b8; font-size:.9rem; }
</style>
{% endblock %}