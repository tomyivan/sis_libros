{% extends 'base.html' %}

{% block title %}Paises{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Países</h2>
    <button class="btn btn-primary" id="btnNewPais">Agregar país</button>
  </div>
  <div class="mb-3 d-flex">
    <input id="paisesSearch" class="form-control me-2" placeholder="Buscar países (mín 3 caracteres)..." />
  </div>

  <div id="paisesContainer">
    {% if paises %}
    <div class="list-group" id="paisesList">
      {% for p in paises %}
        <div class="list-group-item d-flex justify-content-between align-items-center" data-id="{{ p._id }}">
          <div>
            <div class="fw-semibold">{{ p.nombre }}</div>
          </div>
          <div>
            <button class="btn btn-sm btn-outline-secondary btnEditPais" data-id="{{ p._id }}" data-nombre="{{ p.nombre|e }}">Editar</button>
            <button class="btn btn-sm btn-outline-danger btnDeletePais" data-id="{{ p._id }}" data-nombre="{{ p.nombre|e }}">Eliminar</button>
          </div>
        </div>
      {% endfor %}
    </div>
    {% else %}
      <p id="noPaisesMsg">No hay países.</p>
    {% endif %}
  </div>

  <div class="text-center my-3">
    <button id="paisesLoadMore" class="btn btn-outline-primary">Cargar más</button>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function(){
    // Modal HTML template
    const modalHtml = `
    <div class="modal fade" id="paisModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paisModalLabel">Nuevo país</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="paisForm">
                        <input type="hidden" name="edit_id" id="pais_edit_id" />
                        <div class="mb-3">
                            <label class="form-label">Nombre</label>
                            <input name="nombre" id="pais_nombre" class="form-control" required />
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button id="paisSave" type="submit" form="paisForm" class="btn btn-primary">Guardar</button>
                </div>
            </div>
        </div>
    </div>`;

    // Append modal once
    if(!document.getElementById('paisModal')){
        $('body').append(modalHtml);
    }

    const paisModalEl = document.getElementById('paisModal');
    const paisModal = paisModalEl ? new bootstrap.Modal(paisModalEl) : null;

    $('#btnNewPais').on('click', function(){
        $('#paisModalLabel').text('Nuevo país');
        const f = document.getElementById('paisForm'); if(f) f.reset();
        document.getElementById('pais_edit_id').value = '';
        paisModal && paisModal.show();
    });

    $(document).on('click', '.btnEditPais', function(){
        const id = $(this).data('id');
        const nombre = $(this).data('nombre');
        $('#paisModalLabel').text('Editar país');
        document.getElementById('pais_nombre').value = nombre || '';
        document.getElementById('pais_edit_id').value = id || '';
        paisModal && paisModal.show();
    });

    // Guardar país (crear o actualizar)
    const paisFormEl = document.getElementById('paisForm');
    if(paisFormEl && !paisFormEl.dataset.initialized){
        paisFormEl.addEventListener('submit', function(e){
            e.preventDefault();
            const id = document.getElementById('pais_edit_id').value;
            const nombre = document.getElementById('pais_nombre').value.trim();
            if(!nombre){ alert('El nombre es requerido'); return; }
            const url = id ? '{{ url_for("pais.actualizar_pais", pais_id="") }}' + id : '{{ url_for("pais.crear_pais") }}';
            const method = id ? 'PUT' : 'POST';
            $.ajax({
                url: url,
                method: method,
                contentType: 'application/json',
                data: JSON.stringify({ nombre }),
                success: function(r){
                    if(!r.estado){ alert('Error en la operación'); return; }
                    try{ paisModal && paisModal.hide(); }catch(e){}
                    alert('Se Guardó el país');
                    $('#paisesList').empty();
                    obtenerPaises({}, 0, 10);
                },
                error: function(jqXHR){ const j = jqXHR.responseJSON || {}; alert(j.message || 'Error en la operación'); }
            });
        });
        paisFormEl.dataset.initialized = '1';
    }

    function appendPais(p){
      const html = `
        <div class="list-group-item d-flex justify-content-between align-items-center" data-id="${p._id}">
          <div>
            <div class="fw-semibold">${p.nombre}</div>
          </div>
          <div>
            <button class="btn btn-sm btn-outline-secondary btnEditPais" data-id="${p._id}" data-nombre="${(p.nombre||'').replace(/"/g,'\"')}">Editar</button>
            <button class="btn btn-sm btn-outline-danger btnDeletePais" data-id="${p._id}" data-nombre="${(p.nombre||'').replace(/"/g,'\"')}">Eliminar</button>
          </div>
        </div>`;
      $('#paisesList').append(html);
    }

  function obtenerPaises(filtro= {}, offset = 0, limit = 10){
    const apiUrl = '{{ url_for("pais.obtener_paises") }}';
    $.ajax({
      url: apiUrl,
      method: 'GET',
      data: { ...filtro, offset, limit },
      success: function(response){
        console.log('Paises response:', response);
        if(response && response.estado){
          if(response.data.paises.length > 0){
            $('#noPaisesMsg').addClass('d-none');
            if(!$('#paisesList').length){
              $('#paisesContainer').html('<div class="list-group" id="paisesList"></div>');
            }
            response.data.paises.forEach(p => {
              appendPais(p);
            });
          } else if(offset === 0){
            $('#noPaisesMsg').removeClass('d-none');
          }
        } else {
          alert(response?.msg || 'Error al obtener países');
        }
      },
    })
  }

  $(document).on('keyup', '#paisesSearch', function(e) {
    const val = e.target.value.trim();
    if(val.length >= 3 || val.length === 0){
      $('#paisesList').empty();
      obtenerPaises(val.length >= 3 ? { q: val } : {}, 0, 10);
    }
  });

  
  $(document).on('click', '#paisesLoadMore', function() {
    const currentCount = $('#paisesList .list-group-item').length;
    const searchTerm = $('#paisesSearch').val().trim();
    obtenerPaises(searchTerm.length >= 3 ? { q: searchTerm } : {}, currentCount, 10);
  });
});
</script>

{% endblock %}
