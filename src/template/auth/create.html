<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Registrate - Sistema de Recomendación de Libros</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root{--accent:#4f46e5;--glass:rgba(255,255,255,0.06)}
        html,body{height:100%;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
        body{
            margin:0;
            background: linear-gradient(135deg,#0f172a 0%, #0f172a 40%, #071026 100%);
            color: #e6eef8;
            overflow:hidden;
        }
        /* animated subtle gradient shapes */
        .bg-shape{
            position:fixed;inset:0;z-index:0;pointer-events:none;opacity:.45;background:
                radial-gradient(600px 400px at 10% 20%, rgba(79,70,229,0.18), transparent 15%),
                radial-gradient(500px 350px at 90% 80%, rgba(14,165,233,0.12), transparent 12%),
                linear-gradient(180deg, rgba(7,10,25,0.65), rgba(7,10,25,0.85));
            background-size: 120% 120%;
            animation: floatBg 12s ease-in-out infinite alternate;
        }
        @keyframes floatBg{from{background-position:0% 0%}to{background-position:100% 100%}}

        .center-wrap{position:relative;z-index:2;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:2rem}
        .card-glass{
            background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
            border: 1px solid rgba(255,255,255,0.06);
            backdrop-filter: blur(10px);
            box-shadow: 0 18px 60px rgba(2,6,23,0.6);
            border-radius: 14px;
            padding: 0;
            width: 960px;
            max-width: calc(100% - 2rem);
            overflow: hidden;
        }
        .brand-icon{
            width:64px;height:64px;display:inline-flex;align-items:center;justify-content:center;border-radius:12px;background:linear-gradient(135deg,var(--accent),#06b6d4);color:white;font-size:1.9rem;box-shadow:0 8px 20px rgba(79,70,229,0.2);transform-origin:center;animation:iconPop 1.6s ease-in-out infinite;
        }
        @keyframes iconPop{0%{transform:scale(1)}50%{transform:scale(1.06)}100%{transform:scale(1)}}
        h1.h3{color:#e6eef8;font-weight:700}
        .muted-lite{color:rgba(230,238,248,0.75)}
        .form-control:focus{box-shadow:0 8px 28px rgba(79,70,229,0.10);border-color:rgba(79,70,229,0.8)}
        .form-control{
            border-radius:10px; padding:1rem .75rem; background: rgba(255,255,255,0.02); color: #e6eef8; border: 1px solid rgba(255,255,255,0.06);
            transition: box-shadow .18s, transform .08s;
        }
        .form-control:focus{transform: translateY(-2px)}
    .form-floating > label { padding: .5rem .75rem; color: rgba(230,238,248,0.75); transition: color .12s ease, transform .12s ease; }
    /* Ensure floating inputs have consistent height and alignment */
    .form-floating .form-control{min-height:56px;padding:1rem .75rem;border-radius:10px}
    .form-floating .form-control::placeholder{color:transparent}
        .form-text.muted-lite{color:rgba(230,238,248,0.65)}
        .btn-primary{background:linear-gradient(90deg,var(--accent),#06b6d4);border:none}
        .btn-primary:disabled{opacity:0.7}
    .btn-signin{padding: .9rem 1.25rem;font-weight:700;border-radius:12px}
        .alert{border-radius:10px}
        .helper{font-size:.9rem;color:rgba(230,238,248,0.7)}
        footer.small{color:rgba(230,238,248,0.45);text-align:center;margin-top:1rem}
        /* grid form styles */
        .form-grid .col-md-6{padding-left:.6rem;padding-right:.6rem}
        @media (max-width:991px){ .card-glass{width:100%;} }
        @media (max-width:767px){ .card-glass{padding:1rem} .form-control{padding:.85rem .6rem} }
    </style>
</head>
<body>
    <div class="bg-shape" aria-hidden="true"></div>

    <main class="center-wrap">
        <div class="card-glass">
            <div class="row g-0">
                <div class="col-lg-5 d-none d-lg-block" style="background: linear-gradient(180deg, rgba(79,70,229,0.12), rgba(47,209,174,0.06));">
                    <div class="p-5 h-100 d-flex flex-column justify-content-center text-white">
                        <div class="px-3">
                            <div class="brand-icon mb-3" style="width:72px;height:72px;">
                                <i class="bi bi-book-half" style="font-size:1.6rem"></i>
                            </div>
                            <h2 class="h4 mb-2">Bienvenido a SisLibros</h2>
                            <p class="muted-lite">Regístrate para recibir recomendaciones personalizadas y mantener tu lista de lectura organizada.</p>
                            <ul class="mt-4" style="list-style:none;padding:0;">
                                <li class="mb-2"><i class="bi bi-check2-circle me-2" style="color:var(--accent)"></i>Recomendaciones personalizadas</li>
                                <li class="mb-2"><i class="bi bi-check2-circle me-2" style="color:var(--accent)"></i>Historial y calificaciones</li>
                                <li class="mb-2"><i class="bi bi-check2-circle me-2" style="color:var(--accent)"></i>Interfaz limpia y rápida</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-lg-7 p-4">
                    <div class="px-3">
                        <!-- Mostrar mensajes flash -->
                        {% with messages = get_flashed_messages(with_categories=true) %}
                            {% if messages %}
                                {% for category, message in messages %}
                                    <div class="alert alert-{% if category == 'error' %}danger{% elif category == 'success' %}success{% else %}info{% endif %} alert-dismissible fade show" role="alert">
                                        {{ message }}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                    </div>
                                {% endfor %}
                            {% endif %}
                        {% endwith %}

                        <form id="registerForm" action="/usuario/crear" method="POST" novalidate>
                            {% if csrf_token is defined %}
                              <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                            {% endif %}

                            <div class="text-center mb-3">
                                <h2 class="h5 mb-1">Crea tu cuenta</h2>
                                <p class="muted-lite small">Únete y comienza a recibir recomendaciones personalizadas.</p>
                            </div>

                            <div class="form-grid row">
                                <div class="col-12 col-md-6 mb-2">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="nombre" name="nombre" placeholder="Nombre" required>
                                        <label for="nombre">Nombre</label>
                                        <div class="invalid-feedback">Introduce tu nombre.</div>
                                    </div>
                                </div>
                                <div class="col-12 col-md-6 mb-2">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="apellido" name="apellido" placeholder="Apellido" required>
                                        <label for="apellido">Apellido</label>
                                        <div class="invalid-feedback">Introduce tu apellido.</div>
                                    </div>
                                </div>

                                <div class="col-12 col-md-6 mb-2">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="alias" name="alias" placeholder="Alias" required>
                                        <label for="alias">Alias</label>
                                        <div class="invalid-feedback">Introduce un alias de usuario.</div>
                                    </div>
                                </div>
                                <div class="col-12 col-md-6 mb-2">
                                    <div class="form-floating">
                                        <input type="email" class="form-control" id="email" name="email" placeholder="correo@ejemplo.com" required>
                                        <label for="email">Correo electrónico</label>
                                        <div class="invalid-feedback">Introduce un correo válido.</div>
                                    </div>
                                </div>

                                <div class="col-12 col-md-6 mb-2">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="pais" name="pais" placeholder="País" required>
                                        <label for="pais">País</label>
                                        <div class="invalid-feedback">Introduce tu país.</div>
                                    </div>
                                </div>
                                <div class="col-12 col-md-6 mb-2">
                                    <div class="form-floating">
                                        <input type="number" class="form-control" id="edad" name="edad" placeholder="Edad" required min="0" max="150">
                                        <label for="edad">Edad</label>
                                        <div class="invalid-feedback">Introduce una edad válida.</div>
                                    </div>
                                </div>

                                <div class="col-12 col-md-6 mb-2">
                                    <div class="form-floating">
                                        <input type="password" class="form-control" id="password_hash" name="password_hash" placeholder="Contraseña" required minlength="6">
                                        <label for="password_hash">Contraseña</label>
                                        <div class="invalid-feedback">La contraseña debe tener al menos 6 caracteres.</div>
                                    </div>
                                </div>
                                <div class="col-12 col-md-6 mb-2">
                                    <div class="form-floating">
                                        <input type="password" class="form-control" id="password_hash2" name="password_hash2" placeholder="Confirmar Contraseña" required minlength="6">
                                        <label for="password_hash2">Confirmar Contraseña</label>
                                        <div class="invalid-feedback" id="pwdMismatch">Las contraseñas no coinciden.</div>
                                    </div>
                                </div>

                                <div class="col-12 mt-3 d-flex gap-2 align-items-center">
                                    <button class="btn btn-primary btn-signin flex-grow-1" type="submit">
                                        <span class="spinner-border spinner-border-sm d-none" id="regSpinner"></span>
                                        <span id="regText">Crear cuenta</span>
                                    </button>
                                    <a class="btn  btn-outline-light" href="#" onclick="history.back();return false;">Cancelar</a>
                                </div>
                            </div>

                            <div class="mt-3 d-flex justify-content-between align-items-center">
                                <small class="helper">¿Ya tienes cuenta? <a href="{{ url_for('auth.login') if url_for is defined else '#' }}" class="helper">Inicia sesión</a></small>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div style="height:8px"></div>
        <footer class="small"> {{ config.APP_NAME if config is defined else 'SisLibros' }}{% if current_year is defined %} - {{ current_year }}{% endif %}</footer>
    </main>

    <!-- Bootstrap JS bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        (function(){
            const form = document.getElementById('registerForm');
            if(!form) return;
            const spinner = document.getElementById('regSpinner');
            const text = document.getElementById('regText');

            function showAlert(type, message){
                // type: 'success'|'danger'|'info'
                const container = document.createElement('div');
                container.className = `alert alert-${type} alert-dismissible fade show`;
                container.role = 'alert';
                container.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
                const parent = form.parentElement;
                parent.insertBefore(container, parent.firstChild);
                setTimeout(()=>{ try{ const bs = new bootstrap.Alert(container); bs.close(); }catch(e){} }, 4500);
            }

            form.addEventListener('submit', async function(e){
                e.preventDefault();
                e.stopPropagation();

                // HTML5 constraint validation
                if(!form.checkValidity()){
                    form.classList.add('was-validated');
                    return;
                }

                const pwd = document.getElementById('password_hash');
                const pwd2 = document.getElementById('password_hash2');
                const mismatch = document.getElementById('pwdMismatch');
                if(mismatch) mismatch.style.display = 'none';
                if(pwd && pwd2 && pwd.value !== pwd2.value){
                    if(mismatch) mismatch.style.display = 'block';
                    pwd2.classList.add('is-invalid');
                    return;
                }

                // Build payload
                const formData = new FormData(form);
                const payload = {};
                for(const [k,v] of formData.entries()){
                    // skip password confirmation field
                    if(k === 'password_hash2') continue;
                    payload[k] = v;
                }

                // show spinner
                spinner.classList.remove('d-none');
                text.textContent = 'Creando cuenta...';
                const button = form.querySelector('button[type="submit"]');
                if(button) button.disabled = true;

                try{
                    const res = await fetch(form.action || '/usuario/crear', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    const data = await res.json().catch(()=>null);
                    if(!res.ok){
                        const msg = (data && data.message) || (data && data.error) || 'Error al crear usuario';
                        showAlert('danger', msg);
                        return;
                    }

                    // éxito
                    showAlert('success', (data && data.data && data.data.message) ? data.data.message : 'Usuario creado correctamente');
                    // redirect to login after short delay
                    setTimeout(()=>{ window.location.href = '/auth/login'; }, 1200);

                }catch(err){
                    console.error(err);
                    showAlert('danger','Error de red al crear usuario');
                }finally{
                    spinner.classList.add('d-none');
                    text.textContent = 'Crear cuenta';
                    if(button) button.disabled = false;
                }
            });
        })();

        // Auto-hide alerts after 5 seconds (for server-rendered flashes)
        setTimeout(() => {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                if (alert) {
                    try { const bsAlert = new bootstrap.Alert(alert); bsAlert.close(); } catch(e) { /* ignore */ }
                }
            });
        }, 5000);
    </script>
</body>
</html>