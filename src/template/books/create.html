{% extends 'base.html' %}

{% block title %}Agregar Libro{% endblock %}

{% block extra_css %}
<style>
  .animate-card{ transform: translateY(18px); opacity: 0; transition: all 380ms ease-out; }
  .animate-card.show{ transform: translateY(0); opacity: 1; }
  .input-hover:hover{ box-shadow: 0 6px 18px rgba(91,141,239,0.12); transition: box-shadow .18s ease; }
  .input-hover .form-control:focus{ box-shadow: 0 8px 24px rgba(91,141,239,0.18); border-color: #5b8def; }
  .card-header .bi{ font-size: 1.6rem; }
  .form-control-lg{ padding: .75rem 1rem; }
  .needs-validation .is-invalid{ box-shadow: none; }
  @media (prefers-reduced-motion: reduce){ .animate-card{ transition: none; } }
</style>
<!-- Select2 CSS -->
<!-- Select2 CSS moved to base.html -->
{% endblock %}

{% block content %}
<div class="container ">
  <div class="row justify-content-center">
    <div class="col-lg-9 col-md-10">
      <div class="card shadow-lg p-0 rounded-4 overflow-hidden animate-card">
        <div class="card-header p-4 text-white" style="background: linear-gradient(135deg,#5b8def 0%, #7ad0ff 100%);">
          <div class="d-flex align-items-center">
            <div class="me-3 display-6">
              <i class="bi bi-book-half"></i>
            </div>
            <div>
              <h3 class="mb-0">Agregar / Editar Libro</h3>
              <small class="opacity-75">Completa la información básica para tu catálogo</small>
            </div>
          </div>
        </div>
        <div class="card-body p-4 bg-white">
          {% if errors %}
            <div class="alert alert-warning rounded-3">
              <strong>Errores:</strong>
              <ul class="mb-0">
                {% for field, msgs in errors.items() %}
                  <li><strong>{{ field }}:</strong> {{ msgs }}</li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}

          <form id="bookForm" 
                        class="row g-3 needs-validation" novalidate>
            <input type="hidden" name="edit_id" id="book_edit_id" value="{{ request.args.get('edit_id', '') }}" />

            <div class="col-md-6">
              <label class="form-label small">Título</label>
              <div class="input-group shadow-sm input-hover">
                <span class="input-group-text bg-white"><i class="bi bi-type"></i></span>
                <input name="titulo" id="titulo" class="form-control form-control-lg {% if errors and errors.get('titulo') %}is-invalid{% endif %}" placeholder="Ej. Cien años de soledad" required value="{{ data.titulo if data else '' }}" />
                {% if errors and errors.get('titulo') %}
                  <div class="invalid-feedback">{{ errors.get('titulo') }}</div>
                {% endif %}
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label small">Autor</label>
              <div class="input-group shadow-sm input-hover">
                <span class="input-group-text bg-white"><i class="bi bi-person"></i></span>
                <input name="autor" id="autor" class="form-control form-control-lg {% if errors and errors.get('autor') %}is-invalid{% endif %}" placeholder="Nombre del autor" required value="{{ data.autor if data else '' }}" />
                {% if errors and errors.get('autor') %}
                  <div class="invalid-feedback">{{ errors.get('autor') }}</div>
                {% endif %}
              </div>
            </div>

            <div class="col-md-4">
              <label class="form-label small">Género</label>
              <select id="genero_select" multiple class="form-select {% if errors and errors.get('genero') %}is-invalid{% endif %}" aria-label="Selecciona géneros">
                {% if generos %}
                  {% for g in generos %}
                    <option value="{{ g.nombre }}" {% if data and data.genero and (g.nombre in (data.genero if data.genero else [])) %}selected{% endif %}>{{ g.nombre }}</option>
                  {% endfor %}
                {% endif %}
              </select>
              <input type="hidden" name="genero" id="genero" value="{{ data.genero if data else '' }}" required />
              <small class="form-text text-muted">Puedes seleccionar varios géneros (Ctrl/Cmd + clic).</small>
            </div>

            <div class="col-md-4">
              <label class="form-label small">Año</label>
              <input name="año_publicacion" id="anio" type="number" min="0" max="2100" class="form-control {% if errors and errors.get('año_publicacion') %}is-invalid{% endif %}" required value="{{ data.año_publicacion if data else data.get('año_publicacion') if data else '' }}" />
            </div>

            <div class="col-md-4">
              <label class="form-label small">Páginas</label>
              <input name="paginas" id="paginas" type="number" min="1" class="form-control {% if errors and errors.get('paginas') %}is-invalid{% endif %}" required value="{{ data.paginas if data else '' }}" />
            </div>

            <div class="col-md-6">
              <label class="form-label small">Editorial</label>
              <input name="editorial" id="editorial" class="form-control" placeholder="Editorial" required value="{{ data.editorial if data else '' }}" />
            </div>

            <div class="col-md-4">
              <label class="form-label small">Idioma</label>
              <select name="idioma" id="idioma_select" class="form-select" required>
                <option value="">Selecciona un idioma...</option>
                {% if idiomas %}
                  {% for i in idiomas %}
                    <option value="{{ i.nombre }}" {% if data and data.idioma == i.nombre %}selected{% endif %}>{{ i.nombre }}</option>
                  {% endfor %}
                {% endif %}
              </select>
            </div>

            <div class="col-12">
              <label class="form-label small">ISBN</label>
              <input name="isbn" id="isbn" class="form-control" placeholder="978-..." value="{{ data.isbn if data else '' }}" />
            </div>

            <div class="col-md-4">
              <label class="form-label small">País de origen</label>
              <select name="origen_pais" id="origen_select" class="form-select" required>
                <option value="">Selecciona un país...</option>
                {% if paises %}
                  {% for p in paises|sort(attribute='nombre') %}
                    <option value="{{ p.nombre }}" {% if data and data.origen_pais == p.nombre %}selected{% endif %}>{{ p.nombre }}</option>
                  {% endfor %}
                {% endif %}
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label small">Categoría</label>
              <select name="categoria" id="categoria_select" class="form-select">
                <option value="">Sin categoría</option>
                {% if categorias %}
                  {% for c in categorias %}
                    <option value="{{ c.nombre }}" {% if data and data.get('categoria') == c.nombre %}selected{% endif %}>{{ c.nombre }}</option>
                  {% endfor %}
                {% endif %}
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label small">Tags</label>
              <select id="tags_select" multiple class="form-select">
                {% if tags %}
                  {% for t in tags %}
                    <option value="{{ t.nombre }}" {% if data and data.get('tags') and (t.nombre in data.get('tags')) %}selected{% endif %}>{{ t.nombre }}</option>
                  {% endfor %}
                {% endif %}
              </select>
              <input type="hidden" name="tags" id="tags" value="{% if data and data.get('tags') %}{{ data.get('tags')|join(',') }}{% endif %}" />
              <small class="form-text text-muted">Selecciona los tags relevantes (Ctrl/Cmd + clic).</small>
            </div>

            <div class="col-12">
              <label class="form-label small">Descripción</label>
              <textarea name="descripcion" id="descripcion" class="form-control" rows="4" placeholder="Una breve sinopsis...">{{ data.descripcion if data else '' }}</textarea>
            </div>

            <div class="col-12 d-flex justify-content-end gap-2 mt-2">
              <a href="{{ url_for('libro.lista_libros_web') }}" class="btn btn-outline-secondary">Cancelar</a>
              <button id="bookSave" class="btn btn-primary btn-lg px-4" type="submit">
                <span id="bookSpinner" class="spinner-border spinner-border-sm d-none me-2" role="status" aria-hidden="true"></span>
                <span id="bookSaveText">Guardar</span>
              </button>
            </div>

          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
// Bootstrap validation + submit spinner (jQuery)
$(function(){
  // initSelect2: initialize Select2 widgets used on this page. Exposed globally so other scripts can call it.
  function initSelect2_local(){
    try{
      if(typeof window.$ === 'undefined' || !window.$) return;
      if(!$.fn || !$.fn.select2) return;
      var $g = $('#genero_select');
      if ($g.length && !$g.data('select2')) {
        $g.select2({placeholder:'Selecciona géneros', width:'100%'});
        // set initial values from selected options or hidden input
        try{
          var initG = $g.find('option:selected').map(function(){ return this.value; }).get();
          if(!initG || initG.length === 0){
            var hidden = $('#genero').val() || '';
            initG = hidden ? hidden.split(',').map(function(x){ return x.trim(); }).filter(Boolean) : [];
          }
          if(initG && initG.length) { $g.val(initG).trigger('change'); }
        }catch(e){/* ignore */}
      }

      var $t = $('#tags_select');
      if ($t.length && !$t.data('select2')) {
        $t.select2({tags:true, tokenSeparators:[','], width:'100%'});
        // for tags, ensure hidden CSV values become selected tags (add missing options)
        try{
          var hiddenTags = ($('#tags').val() || '').split(',').map(function(x){ return x.trim(); }).filter(Boolean);
          var selected = $t.find('option:selected').map(function(){ return this.value; }).get() || [];
          var toSet = selected.length ? selected : hiddenTags;
          if(toSet && toSet.length){
            toSet.forEach(function(tag){
              if($t.find('option[value="'+tag.replace(/"/g,'\"')+'"]').length === 0){
                var newOpt = new Option(tag, tag, true, true);
                $t.append(newOpt);
              } else {
                $t.find('option').filter(function(){ return this.value === tag; }).prop('selected', true);
              }
            });
            $t.trigger('change');
          }
        }catch(e){/* ignore */}
      }

      var $i = $('#idioma_select'); if ($i.length && !$i.data('select2')) { $i.select2({placeholder:'Selecciona un idioma', width:'100%'}); try{ var sv = $i.find('option:selected').val(); if(sv) $i.val(sv).trigger('change'); }catch(e){} }
      var $c = $('#categoria_select'); if ($c.length && !$c.data('select2')) { $c.select2({placeholder:'Selecciona una categoría', allowClear:true, width:'100%'}); try{ var cv = $c.find('option:selected').val(); if(cv) $c.val(cv).trigger('change'); }catch(e){} }
      var $p = $('#origen_select'); if ($p.length && !$p.data('select2')) { $p.select2({placeholder:'Selecciona un país', width:'100%'}); try{ var pv = $p.find('option:selected').val(); if(pv) $p.val(pv).trigger('change'); }catch(e){} }
    }catch(e){ console.warn('initSelect2_local error', e); }
  }
  // Expose globally
  try{ window.initSelect2 = initSelect2_local; }catch(e){ /* ignore */ }

  var $form = $('#bookForm');
  var $saveBtn = $('#bookSave');
  var $spinner = $('#bookSpinner');
  var $saveText = $('#bookSaveText');

  var $generoSelect = $('#genero_select');
  var $generoHidden = $('#genero');
  var $tagsSelect = $('#tags_select');
  var $tagsHidden = $('#tags');
  var $idiomaSelect = $('#idioma_select');
  var $paisSelect = $('#origen_select');
  var $categoriaSelect = $('#categoria_select');

  // Ensure initSelect2 is available; call it on ready (may be defined in other scripts)
  if (typeof window.initSelect2 === 'function') window.initSelect2();

  if (!$form.length) return;

  $form.on('submit', function(e){
    e.preventDefault();
    e.stopPropagation();

    // clear previous validation state
    $form.find('.is-invalid').removeClass('is-invalid');
    $form.find('.invalid-feedback.ajax-error').remove();
    $('.ajax-top-alert').remove();

    // serialize multiselects into hidden inputs (use Select2 API when available)
    if ($generoHidden.length){
      var vals = [];
      try{ vals = $generoSelect.val() || []; }catch(err){ vals = $generoSelect.find('option:selected').map(function(){ return this.value; }).get(); }
      $generoHidden.val($.isArray(vals) ? vals.filter(Boolean).join(',') : [vals].filter(Boolean).join(','));
    }
    if ($tagsHidden.length){
      var tvals = [];
      try{ tvals = $tagsSelect.val() || []; }catch(err){ tvals = $tagsSelect.find('option:selected').map(function(){ return this.value; }).get(); }
      $tagsHidden.val($.isArray(tvals) ? tvals.filter(Boolean).join(',') : [tvals].filter(Boolean).join(','));
    }

    // HTML5 validation client-side
    if (this.checkValidity && !this.checkValidity()){
      $form.addClass('was-validated');
      return false;
    }

    // prepare JSON payload
    function toInt(v){ var n = parseInt(v); return isNaN(n) ? null : n; }
    function toList(csv){ if(!csv) return []; return csv.split(',').map(function(x){ return x.trim(); }).filter(Boolean); }

    var payload = {
      titulo: $('#titulo').val(),
      autor: $('#autor').val(),
      genero: $('#genero').val() || '',
      año_publicacion: toInt($('#anio').val()),
      editorial: $('#editorial').val(),
      isbn: $('#isbn').val(),
      paginas: toInt($('#paginas').val()),
      idioma: $('#idioma_select').val() || '',
      categoria: $('#categoria_select').val() || '',
      descripcion: $('#descripcion').val(),
      origen_pais: $('#origen_select').val() || '',
      disponible: true,
      tags: toList($('#tags').val())
    };

    // disable button to prevent double submit
    if ($saveBtn.length){
      $saveBtn.prop('disabled', true);
      $spinner.removeClass('d-none');
      $saveText.text('Guardando...');
    }

    var postUrl = "{{ url_for('libro.crear_libro_web_post') }}"; // posts to web wrapper which calls API create

    $.ajax({
      url: postUrl,
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(payload),
      dataType: 'json'
    }).done(function(res, textStatus, jqXHR){
      var body = res && (res.data || res.msg || res) || {};
      // success: show flash and redirect to list
      var redirectUrl = "{{ url_for('libro.lista_libros_web') }}";
      // show a temporary alert and redirect
      var $alert = $('<div class="alert alert-success ajax-top-alert" role="alert">Libro creado correctamente. Redirigiendo...</div>');
      $form.before($alert);
      setTimeout(function(){ window.location.href = redirectUrl; }, 800);
    }).fail(function(jqXHR, textStatus){
      var res = jqXHR.responseJSON || {};
      var msg = res.msg || res.data || jqXHR.responseText || 'Error en el servidor';
      // Try to extract validation details if present
      var details = null;
      try{
        // sometimes msg contains a serialized object like "Error de validación: {'titulo': ['...']}"
        if(typeof msg === 'string' && msg.indexOf('{') !== -1){
          var start = msg.indexOf('{');
          var jsonPart = msg.substring(start);
          details = JSON.parse(jsonPart.replace(/'/g, '"'));
        } else if (res.data && typeof res.data === 'object'){
          details = res.data;
        } else if (res.msg && typeof res.msg === 'object'){
          details = res.msg;
        }
      }catch(e){ details = null; }

      if(details && typeof details === 'object'){
        // show inline errors
        Object.keys(details).forEach(function(field){
          var selector = null;
          // map validation keys to form field selectors
          if(field === 'titulo') selector = '#titulo';
          else if(field === 'autor') selector = '#autor';
          else if(field === 'genero') selector = '#genero';
          else if(field === 'año_publicacion' || field === 'año' || field === 'anio') selector = '#anio';
          else if(field === 'editorial') selector = '#editorial';
          else if(field === 'isbn') selector = '#isbn';
          else if(field === 'paginas') selector = '#paginas';
          else if(field === 'idioma') selector = '#idioma_select';
          else if(field === 'categoria') selector = '#categoria_select';
          else if(field === 'descripcion') selector = '#descripcion';
          else if(field === 'origen_pais') selector = '#origen_select';
          else if(field === 'tags') selector = '#tags';

          var messages = details[field];
          var text = Array.isArray(messages) ? messages.join(', ') : String(messages);
          if(selector){
            var $el = $(selector);
            $el.addClass('is-invalid');
            $('<div class="invalid-feedback ajax-error">').text(text).insertAfter($el);
          }
        });
        // also show top alert
        var $top = $('<div class="alert alert-danger ajax-top-alert" role="alert">Por favor corrige los errores del formulario.</div>');
        $form.before($top);
      } else {
        // generic error
        var $top = $('<div class="alert alert-danger ajax-top-alert" role="alert">'+ (typeof msg === 'string' ? msg : 'Error al crear libro') +'</div>');
        $form.before($top);
      }
    }).always(function(){
      if ($saveBtn.length){ $saveBtn.prop('disabled', false); $spinner.addClass('d-none'); $saveText.text('Guardar'); }
    });

    return false;
  });
});
</script>
<script>
// Initialize Select2 for server-rendered idioma/pais options
$(function(){ if (typeof initSelect2 === 'function') initSelect2(); });
</script>
<script>
// entrance animation for the card (jQuery)
$(function(){
  var $card = $('.animate-card');
  if (!$card.length) return;
  setTimeout(function(){ $card.addClass('show'); }, 60);
});
</script>
<script>
// Defensive Select2 check and forced init (helps when plugin loads but selects were not initialized)
$(function(){
  try{
    if(typeof $.fn === 'undefined' || typeof $.fn.select2 === 'undefined'){
      console.warn('Select2 not detected on page. Ensure select2 JS is loaded.');
      return;
    }
    // Force-init commonly used selects. This will re-init even if data('select2') check failed earlier.
    var ids = ['#genero_select','#tags_select','#idioma_select','#categoria_select','#origen_select'];
    ids.forEach(function(sel){
      try{
        var $s = $(sel);
        if($s.length){ $s.select2({ width: '100%' , placeholder: $s.attr('placeholder') || undefined, tags: sel==='#tags_select' ? true : undefined, tokenSeparators: sel==='#tags_select' ? [','] : undefined, allowClear: sel==='#categoria_select' ? true : undefined }); }
      }catch(e){ console.warn('Select2 init error for', sel, e); }
    });
  }catch(err){ console.warn('Select2 defensive init failed', err); }
});
</script>
{% endblock %}