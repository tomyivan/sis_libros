{% extends 'base.html' %}

{% block title %}Agregar Libro{% endblock %}

{% block extra_css %}
<style>
  .animate-card{ transform: translateY(18px); opacity: 0; transition: all 380ms ease-out; }
  .animate-card.show{ transform: translateY(0); opacity: 1; }
  .input-hover:hover{ box-shadow: 0 6px 18px rgba(91,141,239,0.12); transition: box-shadow .18s ease; }
  .input-hover .form-control:focus{ box-shadow: 0 8px 24px rgba(91,141,239,0.18); border-color: #5b8def; }
  .card-header .bi{ font-size: 1.6rem; }
  .form-control-lg{ padding: .75rem 1rem; }
  .needs-validation .is-invalid{ box-shadow: none; }
  /* Cover dropzone styles */
  .cover-drop { border: 1px dashed rgba(15,23,42,0.08); border-radius: 10px; padding: 14px; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:8px; background: linear-gradient(180deg, #fff, #fbfdff); }
  .cover-drop { cursor: pointer; }
  .cover-drop.dragover { border-color: rgba(91,141,239,0.6); box-shadow: 0 8px 30px rgba(91,141,239,0.06); transform: translateY(-2px); }
  .cover-empty { text-align:center; color:#475569; }
  .cover-empty .bi { font-size: 2.2rem; color: #94a3b8; }
  .cover-instructions { font-weight:600; color:#0f172a; margin-top:6px; }
  .cover-preview { position:relative; width: 200px; max-width:100%; }
  .cover-preview img { width:100%; height:auto; border-radius:8px; display:block; }
  .cover-remove-btn { position:absolute; top:8px; right:8px; }
  @media (prefers-reduced-motion: reduce){ .animate-card{ transition: none; } }
</style>
<!-- Select2 CSS -->
<!-- Select2 CSS moved to base.html -->
{% endblock %}

{% block content %}
<div class="container ">
  <div class="row justify-content-center">
    <div class="col-lg-9 col-md-10">
      <div class="card shadow-lg p-0 rounded-4 overflow-hidden animate-card">
        <div class="card-header p-4 text-white" style="background: linear-gradient(135deg,#5b8def 0%, #7ad0ff 100%);">
          <div class="d-flex align-items-center">
            <div class="me-3 display-6">
              <i class="bi bi-book-half"></i>
            </div>
            <div>
              <h3 class="mb-0">Agregar / Editar Libro</h3>
              <small class="opacity-75">Completa la información básica para tu catálogo</small>
            </div>
          </div>
        </div>
        <div class="card-body p-4 bg-white">
          {% if errors %}
            <div class="alert alert-warning rounded-3">
              <strong>Errores:</strong>
              <ul class="mb-0">
                {% for field, msgs in errors.items() %}
                  <li><strong>{{ field }}:</strong> {{ msgs }}</li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}

          <form id="bookForm" 
                        class="row g-3 needs-validation" novalidate>
            <input type="hidden" name="edit_id" id="book_edit_id" value="{{ request.args.get('edit_id', '') }}" />

            <div class="col-md-6">
              <label class="form-label small">Título</label>
              <div class="input-group shadow-sm input-hover">
                <span class="input-group-text bg-white"><i class="bi bi-type"></i></span>
                <input name="titulo" id="titulo" class="form-control form-control-lg {% if errors and errors.get('titulo') %}is-invalid{% endif %}" placeholder="Ej. Cien años de soledad" required value="{{ data.titulo if data else '' }}" />
                {% if errors and errors.get('titulo') %}
                  <div class="invalid-feedback">{{ errors.get('titulo') }}</div>
                {% endif %}
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label small">Autor</label>
              <div class="input-group shadow-sm input-hover">
                <span class="input-group-text bg-white"><i class="bi bi-person"></i></span>
                <input name="autor" id="autor" class="form-control form-control-lg {% if errors and errors.get('autor') %}is-invalid{% endif %}" placeholder="Nombre del autor" required value="{{ data.autor if data else '' }}" />
                {% if errors and errors.get('autor') %}
                  <div class="invalid-feedback">{{ errors.get('autor') }}</div>
                {% endif %}
              </div>
            </div>

            <div class="col-md-4">
              <label class="form-label small">Género</label>
              <select id="genero_select" multiple class="form-select {% if errors and errors.get('genero') %}is-invalid{% endif %}" aria-label="Selecciona géneros">
                {% if generos %}
                  {% for g in generos %}
                    <option value="{{ g.nombre }}" {% if data and data.genero and (g.nombre in (data.genero if data.genero else [])) %}selected{% endif %}>{{ g.nombre }}</option>
                  {% endfor %}
                {% endif %}
              </select>
              <input type="hidden" name="genero" id="genero" value="{{ data.genero if data else '' }}" required />
              <small class="form-text text-muted">Puedes seleccionar varios géneros (Ctrl/Cmd + clic).</small>
            </div>

            <div class="col-md-4">
              <label class="form-label small">Año</label>
              <input name="año_publicacion" id="anio" type="number" min="0" max="2100" class="form-control {% if errors and errors.get('año_publicacion') %}is-invalid{% endif %}" required value="{{ data.año_publicacion if data else data.get('año_publicacion') if data else '' }}" />
            </div>

            <div class="col-md-4">
              <label class="form-label small">Páginas</label>
              <input name="paginas" id="paginas" type="number" min="1" class="form-control {% if errors and errors.get('paginas') %}is-invalid{% endif %}" required value="{{ data.paginas if data else '' }}" />
            </div>

            <div class="col-md-6">
              <label class="form-label small">Editorial</label>
              <input name="editorial" id="editorial" class="form-control" placeholder="Editorial" required value="{{ data.editorial if data else '' }}" />
            </div>

            <div class="col-md-4">
              <label class="form-label small">Idioma</label>
              <select name="idioma" id="idioma_select" class="form-select" required>
                <option value="">Selecciona un idioma...</option>
                {% if idiomas %}
                  {% for i in idiomas %}
                    <option value="{{ i.nombre }}" {% if data and data.idioma == i.nombre %}selected{% endif %}>{{ i.nombre }}</option>
                  {% endfor %}
                {% endif %}
              </select>
            </div>

            <div class="col-12">
              <label class="form-label small">ISBN</label>
              <input name="isbn" id="isbn" class="form-control" placeholder="978-..." value="{{ data.isbn if data else '' }}" />
            </div>

            <div class="col-md-4">
              <label class="form-label small">País de origen</label>
              <select name="origen_pais" id="origen_select" class="form-select" required>
                <option value="">Selecciona un país...</option>
                {% if paises %}
                  {% for p in paises|sort(attribute='nombre') %}
                    <option value="{{ p.nombre }}" {% if data and data.origen_pais == p.nombre %}selected{% endif %}>{{ p.nombre }}</option>
                  {% endfor %}
                {% endif %}
              </select>
            </div>

         

            <div class="col-md-4">
              <label class="form-label small">Tags</label>
              <select id="tags_select" multiple class="form-select">
                {% if tags %}
                  {% for t in tags %}
                    <option value="{{ t.nombre }}" {% if data and data.get('tags') and (t.nombre in data.get('tags')) %}selected{% endif %}>{{ t.nombre }}</option>
                  {% endfor %}
                {% endif %}
              </select>
              <input type="hidden" name="tags" id="tags" value="{% if data and data.get('tags') %}{{ data.get('tags')|join(',') }}{% endif %}" />
              <small class="form-text text-muted">Selecciona los tags relevantes (Ctrl/Cmd + clic).</small>
            </div>

            <div class="col-12">
              <label class="form-label small">Descripción</label>
              <textarea name="descripcion" id="descripcion" class="form-control" rows="4" placeholder="Una breve sinopsis...">{{ data.descripcion if data else '' }}</textarea>
            </div>
            <div class="col-12">
              <label class="form-label small">Portada</label>
              <div id="coverDrop" class="cover-drop" tabindex="0">
                <div id="coverEmpty" class="cover-empty">
                  <i class="bi bi-image"></i>
                  <div class="cover-instructions">Arrastra la imagen aquí o haz click para seleccionar</div>
                  <small class="text-muted">JPG, PNG. Tamaño recomendado 600x900px</small>
                </div>
                <div id="coverPreview" class="cover-preview" style="display:none;">
                  <button type="button" class="btn btn-sm btn-danger cover-remove-btn" id="coverRemove">×</button>
                  <img id="coverImg" src="" alt="Portada preview" />
                </div>
                <input type="file" name="portada" id="portada" class="d-none" accept="image/*" />
              </div>
            </div>
            <div class="col-12 d-flex justify-content-end gap-2 mt-2">
              <a href="{{ url_for('libro.lista_libros_web') }}" class="btn btn-outline-secondary">Cancelar</a>
              <button id="bookSave" class="btn btn-primary btn-lg px-4" type="submit">
                <span id="bookSpinner" class="spinner-border spinner-border-sm d-none me-2" role="status" aria-hidden="true"></span>
                <span id="bookSaveText">Guardar</span>
              </button>
            </div>

          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
// Bootstrap validation + submit spinner (jQuery)
$(function(){
  // initSelect2: initialize Select2 widgets used on this page. Exposed globally so other scripts can call it.
  function initSelect2_local(){
    try{
      if(typeof window.$ === 'undefined' || !window.$) return;
      if(!$.fn || !$.fn.select2) return;

      var $g = $('#genero_select'); if ($g.length && !$g.data('select2')) $g.select2({placeholder:'Selecciona géneros', width:'100%'});
      var $t = $('#tags_select'); if ($t.length && !$t.data('select2')) $t.select2({tags:true, tokenSeparators:[','], width:'100%'});
      var $i = $('#idioma_select'); if ($i.length && !$i.data('select2')) $i.select2({placeholder:'Selecciona un idioma', width:'100%'});
      var $p = $('#origen_select'); if ($p.length && !$p.data('select2')) $p.select2({placeholder:'Selecciona un país', width:'100%'});
    }catch(e){ console.warn('initSelect2_local error', e); }
  }
  // Expose globally
  try{ window.initSelect2 = initSelect2_local; }catch(e){ /* ignore */ }

  var $form = $('#bookForm');
  var $saveBtn = $('#bookSave');
  var $spinner = $('#bookSpinner');
 

  var $generoSelect = $('#genero_select');
  var $generoHidden = $('#genero');
  var $tagsSelect = $('#tags_select');
  var $tagsHidden = $('#tags');
  var $idiomaSelect = $('#idioma_select');
  var $paisSelect = $('#origen_select');

  // Ensure initSelect2 is available; call it on ready (may be defined in other scripts)
  if (typeof window.initSelect2 === 'function') window.initSelect2();

  // COVER DROPZONE logic
  var $coverDrop = $('#coverDrop');
  var $coverInput = $('#portada');
  var $coverEmpty = $('#coverEmpty');
  var $coverPreview = $('#coverPreview');
  var $coverImg = $('#coverImg');
  var $coverRemove = $('#coverRemove');

  function showPreview(file){
    if(!file) return;
    var reader = new FileReader();
    reader.onload = function(e){
      $coverImg.attr('src', e.target.result);
      $coverEmpty.hide();
      $coverPreview.show();
    };
    reader.readAsDataURL(file);
  }

  function clearPreview(){
    $coverInput.val('');
    $coverImg.attr('src','');
    $coverPreview.hide();
    $coverEmpty.show();
  }

  // Click to open file input
  $coverDrop.on('click', function(e){
    // If user clicked the remove button, don't open the file picker
    if($(e.target).closest('#coverRemove').length) return;
    // Use the native DOM click to reliably open the file dialog in all browsers
    if($coverInput && $coverInput[0]){
      try{ $coverInput[0].click(); }catch(err){ $coverInput.trigger('click'); }
    }else{
      $coverInput.trigger('click');
    }
  });
  $coverInput.on('change', function(e){ var f = this.files && this.files[0]; if(f) showPreview(f); });

  // Drag and drop
  $coverDrop.on('dragenter dragover', function(e){ e.preventDefault(); e.stopPropagation(); $coverDrop.addClass('dragover'); });
  $coverDrop.on('dragleave dragend drop', function(e){ e.preventDefault(); e.stopPropagation(); $coverDrop.removeClass('dragover'); });
  $coverDrop.on('drop', function(e){
    var dt = e.originalEvent && e.originalEvent.dataTransfer;
    if(dt && dt.files && dt.files.length){
      var f = dt.files[0];
      $coverInput[0].files = dt.files;  
      showPreview(f);
    }
  });

  $coverRemove.on('click', function(e){ e.stopPropagation(); clearPreview(); });

  if (!$form.length) return;

  $(document).on('submit', '#bookForm', function(e){
    e.preventDefault();
    e.stopPropagation();
    if (this.checkValidity() === false) {
      $form.addClass('was-validated');
      return;
    }
    const data = new FormData(this);
  // Build update URL using a template placeholder to avoid calling url_for without libro_id
  const updateUrlTemplate = "{{ url_for('libro.actualizar_libro', libro_id='__ID__') }}";
  const url = $form.find('#book_edit_id').val() ? updateUrlTemplate.replace('__ID__', $form.find('#book_edit_id').val()) : "{{ url_for('libro.crear_libro') }}";
    data.set('genero', $generoSelect.val() ? $generoSelect.val().join(',') : '');
    data.set('tags', $tagsSelect.val() ? $tagsSelect.val().join(',') : '');
    $.ajax({
      url: url,
      method: $form.find('#book_edit_id').val() ? 'PUT' : 'POST',
      data: data,
      processData: false,
      contentType: false,
      beforeSend: function(){
        $saveBtn.prop('disabled', true);
        $spinner.removeClass('d-none');
      },
      success: function(response){
        console.log('Response from server:', response);
        if(response.estado){
          alert(response.msg || 'Libro guardado exitosamente');
          window.location.href = "{{ url_for('libro.lista_libros_web') }}";
        }
      },
      error: function(){
        alert('Error al guardar el libro. Intenta nuevamente.');
      },
      complete: function(){
        $saveBtn.prop('disabled', false);
        $spinner.addClass('d-none');
      }
    })
  })
});
</script>





<script>
$(function(){ if (typeof initSelect2 === 'function') initSelect2(); });
</script>
<script>

$(function(){
  var $card = $('.animate-card');
  if (!$card.length) return;
  setTimeout(function(){ $card.addClass('show'); }, 60);
});
</script>
<script>
$(function(){
  try{
    if(typeof $.fn === 'undefined' || typeof $.fn.select2 === 'undefined'){
      console.warn('Select2 not detected on page. Ensure select2 JS is loaded.');
      return;
    }
    var ids = ['#genero_select','#tags_select','#idioma_select','#origen_select'];
    ids.forEach(function(sel){
      try{
        var $s = $(sel);
        if($s.length){ $s.select2({ width: '100%' , placeholder: $s.attr('placeholder') || undefined, tags: sel==='#tags_select' ? true : undefined, tokenSeparators: sel==='#tags_select' ? [','] : undefined }); }
      }catch(e){ console.warn('Select2 init error for', sel, e); }
    });
  }catch(err){ console.warn('Select2 defensive init failed', err); }
});
</script>
{% endblock %}