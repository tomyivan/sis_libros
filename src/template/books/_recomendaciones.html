{#
  Partial: recomendaciones
  Expects variable `recs` (list of book dicts). If not provided, defaults to []
#}
{% set recs = recs if (recs is defined) else (recomendaciones if recomendaciones is defined else []) %}
{% if recs and recs|length > 0 %}
  <style>
    /* compact recommendation cards (partial) */
    .rec-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:.6rem;margin-top:.8rem}
    .rec-card{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.005));border-radius:10px;padding:.6rem;border:1px solid rgba(255,255,255,0.04);box-shadow:0 6px 18px rgba(2,6,23,0.28);transition:transform .18s,box-shadow .18s;display:flex;flex-direction:column;}
    .rec-card:hover{transform:translateY(-6px);box-shadow:0 16px 40px rgba(2,6,23,0.42)}
    .rec-cover{height:96px;border-radius:8px;overflow:hidden;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#071022,#052033);color:rgba(255,255,255,0.28)}
    .rec-cover img{display:block;width:100%;height:100%;object-fit:cover}
    .rec-title{font-weight:700;margin-top:.45rem;font-size:.95rem;color:#052033;line-height:1.05}
    .rec-author{font-size:.78rem;color:rgba(25, 0, 247, 0.7);margin-top:2px}
    .rec-desc{font-size:.78rem;color:rgba(53, 53, 53, 0.62);margin-top:.35rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .rec-tags{margin-top:.45rem}
    .rec-tags .badge{background:rgba(255,255,255,0.02);color:rgba(230,238,248,0.78);border-radius:999px;padding:.15rem .4rem;font-size:.65rem;margin-right:.28rem}
    .rec-card a.view-link{color:var(--accent);font-weight:700;text-decoration:none;font-size:.85rem}
    .rec-meta{display:flex;justify-content:space-between;align-items:center;margin-top:.45rem}
    @media (max-width:520px){ .rec-cover{height:84px} .rec-title{font-size:.92rem} }
  </style>

  <div class="mt-4">
    <h5>Recomendaciones</h5>
    <div id="recGrid" class="rec-grid" aria-live="polite"></div>
  </div>

  <!-- embed recommendations as JSON to avoid template-in-js parsing issues -->
  <script id="recs-data" type="application/json">{{ recs|tojson|safe }}</script>
  <script>
    (function(){
      const dataElem = document.getElementById('recs-data');
      let __recsData = [];
      try{ __recsData = dataElem ? JSON.parse(dataElem.textContent || '[]') : []; }catch(e){ __recsData = []; }
      if(!__recsData || __recsData.length === 0) return;

      const take = Math.min(6, __recsData.length);
      const chosen = [];
      const used = new Set();
      while(chosen.length < take){
        const idx = Math.floor(Math.random() * __recsData.length);
        if(used.has(idx)) continue;
        used.add(idx);
        chosen.push(__recsData[idx]);
      }

      const container = document.getElementById('recGrid');
      chosen.forEach(item => {
        const card = document.createElement('div');
        card.className = 'rec-card';

        const cover = document.createElement('div');
        cover.className = 'rec-cover';
        if(item.portada_url){
          const img = document.createElement('img');
          img.src = item.portada_url; img.alt = 'Portada ' + (item.titulo || ''); img.style.borderRadius = '6px';
          cover.appendChild(img);
        } else {
          cover.innerHTML = '<i class="bi bi-book" style="font-size:28px;color:rgba(255,255,255,0.32)"></i>';
        }

        const title = document.createElement('div'); title.className = 'rec-title'; title.textContent = item.titulo || 'Sin título';
        const author = document.createElement('div'); author.className = 'rec-author'; author.textContent = item.autor || '';
        const desc = document.createElement('div'); desc.className = 'rec-desc'; desc.textContent = item.descripcion ? item.descripcion.substring(0,140) + (item.descripcion.length>140? '...':'') : '';

        const tags = document.createElement('div'); tags.className = 'rec-tags';
        if(item.tags && item.tags.length>0){ item.tags.slice(0,3).forEach(t=>{ const s = document.createElement('span'); s.className = 'badge bg-secondary bg-opacity-10 text-secondary me-1'; s.textContent = t; tags.appendChild(s); }); }

        const meta = document.createElement('div'); meta.className = 'd-flex justify-content-between align-items-center mt-2';
        const metaLeft = document.createElement('small'); metaLeft.className = 'text-muted'; metaLeft.textContent = (item.año_publicacion || '') + ' · ' + (item.paginas || '') + ' pág';
        const link = document.createElement('a'); link.className = 'view-link'; link.href = '/libro/info/' + (item._id || ''); link.textContent = 'Ver';
        meta.appendChild(metaLeft); meta.appendChild(link);

        card.appendChild(cover); card.appendChild(title); card.appendChild(author); card.appendChild(desc); card.appendChild(tags); card.appendChild(meta);
        container.appendChild(card);
      });
    })();
  </script>
{% endif %}
